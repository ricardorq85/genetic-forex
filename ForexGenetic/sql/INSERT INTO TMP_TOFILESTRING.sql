DELETE FROM TMP_TOFILESTRING2;
COMMIT;

INSERT INTO TMP_TOFILESTRING2 (ID_INDIVIDUO, CRITERIO_ORDER1, CRITERIO_ORDER2, VIGENCIA1, VIGENCIA2)
  SELECT OPER_MES.ID_INDIVIDUO, SUM(OPER_MES.PIPS), SUM(OPER.PIPS),
  TO_DATE(MESES.MES,'YYYYMM'), ADD_MONTHS(TO_DATE(MESES.MES,'YYYYMM'),1)
  FROM OPERACION_X_MES OPER_MES
    INNER JOIN (SELECT DISTINCT MESES.MES FROM OPERACION_X_MES MESES) MESES
      ON TO_DATE(OPER_MES.MES,'YYYYMM')=ADD_MONTHS(TO_DATE(MESES.MES,'YYYYMM'),-1) 
    INNER JOIN OPERACIONES_ACUM_MES_ANYO OPER_ANYO 
      ON OPER_ANYO.ID_INDIVIDUO=OPER_MES.ID_INDIVIDUO     
        AND TO_DATE(OPER_MES.MES,'YYYYMM')=ADD_MONTHS(TO_DATE(OPER_ANYO.MES,'YYYYMM'),-1) 
    INNER JOIN OPERACIONES_ACUM_MES_CONSOL OPER
      ON OPER_MES.ID_INDIVIDUO=OPER.ID_INDIVIDUO 
      AND TO_DATE(OPER_MES.MES,'YYYYMM')=ADD_MONTHS(TO_DATE(OPER.MES,'YYYYMM'),-1) 
  WHERE EXISTS (SELECT 1 FROM INDICADOR_INDIVIDUO II WHERE OPER_MES.ID_INDIVIDUO=II.ID_INDIVIDUO AND II.INTERVALO_INFERIOR IS NOT NULL)
  AND (( OPER_MES.PIPS>1800 AND OPER_ANYO.PIPS>7500 AND  OPER.PIPS>8500)
  )
  --ID:142774	1800	7500	8500	OPER_MES.PIPS	OPER.PIPS
  --ID:146672	0	9500	2500	OPER_MES.PIPS	OPER_MES.PIPS
  --ID:142934	1800	4000	2000	OPER_ANYO.PIPS	OPER_ANYO.PIPS
  --ID:142979	1800	3000	500	OPER_MES.PIPS	OPER_MES.PIPS
  --ID:142980	1800	3000	0	OPER.PIPS	OPER.PIPS
  --ID:143904	1400	2000	0	OPER_ANYO.PIPS	OPER_MES.PIPS
  --ID:144931	800	9000	1000	OPER.PIPS	OPER.PIPS
  --ID:145059	800	6000	0	OPER_MES.PIPS	OPER_MES.PIPS
  --ID:140752	2800	3500	1000	OPER_ANYO.PIPS	OPER_ANYO.PIPS
  --ID:142284	2000	9000	1500	OPER_ANYO.PIPS	OPER.PIPS  
  --ID:140754	2800	3500	0	OPER_ANYO.PIPS	OPER.PIPS
  --ID:140027	3000	10000	6500	OPER_MES.PIPS	OPER_ANYO.PIPS
  --ID:141130	5095	2600	5000	1000
  --ID:140663	2800	5500	3500 OPER_MES.PIPS	OPER_MES.PIPS
  --ID:141172	2600	4000	1000	OPER_MES.PIPS	OPER_MES.PIPS
  --ID:141193	2600	3500	1000	OPER_ANYO.PIPS	OPER_MES.PIPS
  --ID:139601	3200	9500	9500	OPER.PIPS	OPER.PIPS
  --ID:141130 2600	5000	1000	OPER.PIPS	OPER_MES.PIPS
  --ID:141216	2600	3000	0	OPER_MES.PIPS	OPER_MES.PIPS
  --ID:140907	2600	10000	7500	OPER_ANYO.PIPS	OPER_MES.PIPS
  --ID:140886	2800	0	7500	OPER_ANYO.PIPS	OPER_ANYO.PIPS
  --ID:140794	2800	2500	1000	OPER.PIPS	OPER.PIPS
  
  --AND OPER_MES.CANTIDAD>1
  --AND OPER_MES.TIPO_OPERACION='BUY'
  --AND OPER_MES.ID_INDIVIDUO ='1453664590875.284'
  GROUP BY OPER_MES.ID_INDIVIDUO, MESES.MES
  --ORDER BY MESES.MES ASC
;
commit;

@ToFileStringFromTEMP_TOFILESTRING.sql;
